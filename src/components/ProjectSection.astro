---
import ImageCarousel from './ImageCarousel.astro';
import type { CarouselItem } from './ImageCarousel.astro';

export interface Props {
	image?: string;
	imageAlt?: string;
	/** Carousel items: images and/or videos (type: 'video' for autoplay muted MP4). */
	images?: CarouselItem[];
	subheading: string;
	// Optional MP4 video support
	videoSrc?: string; // e.g., '/videos/demo.mp4' (served from public/)
	poster?: string;   // optional poster image displayed before playback
	controls?: boolean; // default true
	autoplay?: boolean; // if true, will force muted + playsinline to be mobile-friendly
	loop?: boolean;     // loop playback
	muted?: boolean;    // default true when autoplay is enabled
	// Poster image with play overlay: click swaps to video and plays
	videoWithPlayOverlay?: { poster: string; videoSrc: string; alt: string };
	/** Lottie animation JSON URL (e.g. '/animations/hero.json'). Autoplays, loops. */
	lottie?: string;
	lottieAlt?: string;
}

const {
  image,
  imageAlt,
  images,
  subheading,
  videoSrc,
  poster,
  controls = true,
  autoplay = false,
  loop = false,
  muted,
  videoWithPlayOverlay,
  lottie,
  lottieAlt,
} = Astro.props;

// Ensure mobile-safe autoplay behavior: if autoplay is on, force muted true
const effectiveMuted = autoplay ? true : (muted ?? false);
const carouselId = `carousel-${Math.random().toString(36).substr(2, 9)}`;
const playOverlayId = `play-overlay-${Math.random().toString(36).substr(2, 9)}`;
---

<section class="project-section">
	{lottie && (
		<div class="project-image-container project-lottie-wrap">
			<div
				class="project-lottie-container"
				data-lottie-src={lottie}
				role="img"
				aria-label={lottieAlt ?? 'Animation'}
			></div>
		</div>
	)}
	{videoWithPlayOverlay && (
		<div class="project-image-container project-video-play-overlay-wrap" data-play-overlay-id={playOverlayId}>
			<div class="project-video-poster-layer">
				<img src={videoWithPlayOverlay.poster} alt={videoWithPlayOverlay.alt} class="project-image" />
				<button type="button" class="project-video-play-overlay" aria-label="Play video">
					<svg class="project-video-play-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
						<path d="M8 5v14l11-7z"/>
					</svg>
				</button>
			</div>
			<video
				class="project-video project-video-reveal"
				src={videoWithPlayOverlay.videoSrc}
				controls
				playsinline
				preload="metadata"
				data-play-overlay-video
			></video>
		</div>
	)}
	{videoSrc && !videoWithPlayOverlay && (
		<div class="project-image-container">
			<video
				class="project-video"
				src={videoSrc}
				poster={poster}
				controls={controls}
				autoplay={autoplay}
				loop={loop}
				muted={effectiveMuted}
				playsinline
			></video>
		</div>
	)}
	{images && images.length > 1 && (
		<div class="project-image-container">
			<ImageCarousel images={images} id={carouselId} />
		</div>
	)}
	
	{images && images.length === 1 && (
		<div class="project-image-container">
			{images[0].type === 'video' ? (
				<video
					class="project-image project-video"
					src={images[0].src}
					poster={images[0].type === 'video' ? images[0].poster : undefined}
					aria-label={images[0].alt}
					autoplay
					muted
					loop
					playsinline
				></video>
			) : (
				<img src={images[0].src} alt={images[0].alt} class="project-image" />
			)}
		</div>
	)}
	
	{image && !images && !videoWithPlayOverlay && (
		<div class="project-image-container">
			<img src={image} alt={imageAlt} class="project-image" />
		</div>
	)}
	
	{!image && !images && !videoSrc && !videoWithPlayOverlay && !lottie && (
		<div class="project-image-container">
			<div class="project-image-placeholder">{imageAlt || 'Image placeholder'}</div>
		</div>
	)}
	
	<div class="project-content">
		<div class="content-column subheading-column">
			<h3>{subheading}</h3>
		</div>
		<slot />
	</div>
</section>

<script>
	import lottie from 'lottie-web';

	document.addEventListener('DOMContentLoaded', () => {
		document.querySelectorAll<HTMLElement>('.project-video-play-overlay-wrap').forEach((wrap) => {
			const video = wrap.querySelector<HTMLVideoElement>('[data-play-overlay-video]');
			const posterLayer = wrap.querySelector('.project-video-poster-layer');
			if (!video || !posterLayer) return;
			const showVideo = () => {
				wrap.classList.add('is-playing');
				video.play().catch(() => {});
			};
			const showPoster = () => {
				wrap.classList.remove('is-playing');
			};
			posterLayer.addEventListener('click', showVideo);
			video.addEventListener('click', (e) => e.stopPropagation());
			video.addEventListener('ended', showPoster);
		});

		document.querySelectorAll<HTMLElement>('[data-lottie-src]').forEach((el) => {
			const src = el.getAttribute('data-lottie-src');
			if (!src) return;
			lottie.loadAnimation({
				container: el,
				renderer: 'svg',
				loop: true,
				autoplay: true,
				path: src,
			});
		});
	});
</script>
