---
import '../styles/project.css';
import '../styles/global.css';
import Navigation from '../components/Navigation.astro';
import ProjectSubNav from '../components/ProjectSubNav.astro';

export interface Props {
	title: string;
	headline: string;
	intro: string;
	keywords?: string[];
}

const { title, headline, intro, keywords = [] } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{title} | Sean Batchelor</title>
	</head>
	<body>
		<div class="project-overlay" id="project-overlay">
			<p class="project-overlay__swipe-hint">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
				Swipe to read
			</p>
			<ul class="project-overlay__keywords">
				{keywords.map(k => <li>{k}</li>)}
			</ul>
		</div>
		<Navigation currentPath={Astro.url.pathname} />
		<ProjectSubNav currentPath={Astro.url.pathname} />
		<div class="container">

			<!-- Header Section -->
			<header class="project-header">
				<div class="header-content">
					<h1 class="project-title">{title}</h1>
					<h2 class="project-headline">{headline}</h2>
					<p class="project-intro" set:html={intro}></p>
				</div>
			</header>

			<!-- Main Content Area -->
			<main class="project-main">
				<slot />
			</main>
		</div>
		<script>
			const overlay = document.getElementById('project-overlay')!;
			const globalNav = document.querySelector<HTMLElement>('.global-nav');
			const subNav = document.querySelector<HTMLElement>('.project-sub-nav');

			let accumulatedDelta = 0;
			let overlayDone = false;
			const SCROLL_BUDGET_WHEEL = 600;

			const navHeight = (globalNav?.offsetHeight ?? 0) + (subNav?.offsetHeight ?? 0);
			document.documentElement.style.setProperty('--nav-height', `${navHeight}px`);

			// Measure scrollbar width before locking so the page doesn't shift when it disappears
			const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
			document.documentElement.style.overflow = 'hidden';
			document.body.style.overflow = 'hidden';
			document.documentElement.style.paddingRight = `${scrollbarWidth}px`;

			const maxTranslate = overlay.getBoundingClientRect().bottom;

			function unlockPage() {
				overlay.style.pointerEvents = 'none';
				document.documentElement.style.overflow = '';
				document.body.style.overflow = '';
				document.documentElement.style.paddingRight = '';
			}

			// — Wheel (desktop) — tracks 1:1, no transition
			function applyProgress() {
				const progress = Math.min(accumulatedDelta / SCROLL_BUDGET_WHEEL, 1);
				overlay.style.transform = `translateY(${-progress * maxTranslate}px)`;

				if (progress >= 1) {
					overlayDone = true;
					unlockPage();
					window.removeEventListener('wheel', onWheel);
				}
			}

			function onWheel(e: WheelEvent) {
				if (overlayDone) return;
				e.preventDefault();
				accumulatedDelta = Math.max(0, accumulatedDelta + e.deltaY);
				applyProgress();
			}

			window.addEventListener('wheel', onWheel, { passive: false });

			// — Touch (mobile) — binary flick-to-dismiss or snap back
			let touchStartY = 0;
			let touchCurrentY = 0;
			let touchStartTime = 0;

			function onTouchStart(e: TouchEvent) {
				touchStartY = e.touches[0].clientY;
				touchCurrentY = e.touches[0].clientY;
				touchStartTime = Date.now();
				overlay.style.transition = 'none';
			}

			function onTouchMove(e: TouchEvent) {
				if (overlayDone) return;
				e.preventDefault();
				touchCurrentY = e.touches[0].clientY;
				const dragDistance = touchStartY - touchCurrentY;
				if (dragDistance > 0) {
					overlay.style.transform = `translateY(${-dragDistance}px)`;
				}
			}

			function onTouchEnd() {
				if (overlayDone) return;
				const distance = touchStartY - touchCurrentY;
				const velocity = distance / (Date.now() - touchStartTime);

				if (velocity > 0.3 || distance > 80) {
					overlay.style.transition = 'transform 0.35s cubic-bezier(0.32, 0, 0.67, 0)';
					overlay.style.transform = `translateY(-${maxTranslate}px)`;
					overlay.addEventListener('transitionend', () => {
						overlayDone = true;
						unlockPage();
					}, { once: true });
				} else {
					overlay.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
					overlay.style.transform = 'translateY(0)';
				}
			}

			overlay.addEventListener('touchstart', onTouchStart, { passive: true });
			overlay.addEventListener('touchmove', onTouchMove, { passive: false });
			overlay.addEventListener('touchend', onTouchEnd, { passive: true });
		</script>
	</body>
</html>
