---
import '../styles/project.css';
import '../styles/global.css';
import Navigation from '../components/Navigation.astro';
import ProjectSubNav from '../components/ProjectSubNav.astro';

export interface Props {
	title: string;
	headline: string;
	intro: string;
	keywords?: string[];
}

const { title, headline, intro, keywords = [] } = Astro.props;
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{title} | Sean Batchelor</title>
	</head>
	<body>
		<div class="project-overlay" id="project-overlay">
			<ul class="project-overlay__keywords">
				{keywords.map(k => <li>{k}</li>)}
			</ul>
		</div>
		<Navigation currentPath={Astro.url.pathname} />
		<ProjectSubNav currentPath={Astro.url.pathname} />
		<div class="container">

			<!-- Header Section -->
			<header class="project-header">
				<div class="header-content">
					<h1 class="project-title">{title}</h1>
					<h2 class="project-headline">{headline}</h2>
					<p class="project-intro" set:html={intro}></p>
				</div>
			</header>

			<!-- Main Content Area -->
			<main class="project-main">
				<slot />
			</main>
		</div>
		<script>
			const overlay = document.getElementById('project-overlay')!;
			const globalNav = document.querySelector<HTMLElement>('.global-nav');
			const subNav = document.querySelector<HTMLElement>('.project-sub-nav');

			let accumulatedDelta = 0;
			const SCROLL_BUDGET_WHEEL = 600;
			const SCROLL_BUDGET_TOUCH = 250;

			const navHeight = (globalNav?.offsetHeight ?? 0) + (subNav?.offsetHeight ?? 0);
			document.documentElement.style.setProperty('--nav-height', `${navHeight}px`);

			// Measure scrollbar width before locking so the page doesn't shift when it disappears
			const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
			document.documentElement.style.overflow = 'hidden';
			document.body.style.overflow = 'hidden';
			document.documentElement.style.paddingRight = `${scrollbarWidth}px`;

			const maxTranslate = overlay.getBoundingClientRect().bottom;

			function applyProgress(budget: number) {
				const progress = Math.min(accumulatedDelta / budget, 1);
				overlay.style.transform = `translateY(${-progress * maxTranslate}px)`;

				if (progress >= 1) {
					overlay.style.pointerEvents = 'none';
					document.documentElement.style.overflow = '';
					document.body.style.overflow = '';
					document.documentElement.style.paddingRight = '';
					window.removeEventListener('wheel', onWheel);
					overlay.removeEventListener('touchstart', onTouchStart);
					overlay.removeEventListener('touchmove', onTouchMove);
				}
			}

			function onWheel(e: WheelEvent) {
				e.preventDefault();
				accumulatedDelta = Math.max(0, accumulatedDelta + e.deltaY);
				applyProgress(SCROLL_BUDGET_WHEEL);
			}

			let touchStartY = 0;
			function onTouchStart(e: TouchEvent) {
				touchStartY = e.touches[0].clientY;
			}
			function onTouchMove(e: TouchEvent) {
				e.preventDefault();
				accumulatedDelta = Math.max(0, accumulatedDelta + touchStartY - e.touches[0].clientY);
				touchStartY = e.touches[0].clientY;
				applyProgress(SCROLL_BUDGET_TOUCH);
			}

			window.addEventListener('wheel', onWheel, { passive: false });
			overlay.addEventListener('touchstart', onTouchStart, { passive: true });
			overlay.addEventListener('touchmove', onTouchMove, { passive: false });
		</script>
	</body>
</html>
